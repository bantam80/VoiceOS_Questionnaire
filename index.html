<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Technical Form Widget</title>
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; overflow: hidden;}
        
        .loader { 
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 2s linear infinite;
            margin: 50px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        iframe { width: 100%; height: 100vh; border: none; }
        .error { color: #cc0000; padding: 20px; text-align: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading" class="loader"></div>
    <div id="errorMsg" class="error hidden"></div>
    <iframe id="formFrame" class="hidden" src=""></iframe>

    <script>
        // 1. Listen for the PageLoad event to get context (Record ID)
        ZOHO.embeddedApp.on("PageLoad", function(data){
            
            // data.EntityId holds the Deal ID
            // data.Entity holds the Module Name (e.g. Deals)
            var recordId = data.EntityId;
            var module = data.Entity;

            // 2. Fetch the Record Data to find the URL
            ZOHO.CRM.API.getRecord({Entity: module, RecordID: recordId})
            .then(function(response){
                
                // Hide Loader
                document.getElementById("loading").classList.add("hidden");

                // 3. Extract the Link
                // Check if response.data exists and has items
                if(response.data && response.data.length > 0){
                    
                    // Verify API Name: 'Questionnaire_Link'
                    let urlData = response.data[0].Questionnaire_Link;
                    
                    if(urlData && urlData.startsWith("http")){
                        let frame = document.getElementById("formFrame");
                        frame.src = urlData;
                        frame.classList.remove("hidden");
                    } else {
                        showError("The Questionnaire Link field is empty.<br>Please ensure the record is saved so the link is generated.");
                    }
                } else {
                    showError("Could not retrieve record data.");
                }
            })
            .catch(function(err){
                showError("API Error: " + JSON.stringify(err));
            });
        });

        // 4. Initialize the connection
        ZOHO.embeddedApp.init();

        function showError(msg) {
            document.getElementById("loading").classList.add("hidden");
            var errDiv = document.getElementById("errorMsg");
            errDiv.innerHTML = "<b>Error:</b> " + msg;
            errDiv.classList.remove("hidden");
        }
    </script>
</body>
</html>
