<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Technical Form Widget</title>
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; overflow: hidden;}

        /* The Loader */
        .loader { 
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 2s linear infinite;
            margin: 50px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        iframe { width: 100%; height: 100vh; border: none; }
        .error { color: #cc0000; padding: 20px; text-align: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading" class="loader"></div>
    <div id="errorMsg" class="error hidden"></div>
    <iframe id="formFrame" class="hidden" src=""></iframe>

    <script>
        ZOHO.embeddedApp.init().then(function(){

            // Get the BluePrint Context
            ZOHO.CRM.BLUEPRINT.proceed().then(function(response){

                let recordId = response.blueprint.recordId;

                // Fetch the actual record data to get the URL
                ZOHO.CRM.API.getRecord({Entity:"Deals", RecordID:recordId})
                .then(function(data){

                    // Hide Loader
                    document.getElementById("loading").classList.add("hidden");

                    // Grab the Link
                    // CHECK THIS: Ensure 'Questionnaire_Link' matches your API Name exactly
                    let urlData = data.data[0].Questionnaire_Link;

                    if(urlData && urlData.startsWith("http")){
                        let frame = document.getElementById("formFrame");
                        frame.src = urlData;
                        frame.classList.remove("hidden");
                    } else {
                        let err = document.getElementById("errorMsg");
                        err.innerHTML = "<b>Error:</b> The Questionnaire Link is empty.<br>Please ensure the record is saved and the link generated.";
                        err.classList.remove("hidden");
                    }
                });
            });
        });
    </script>
</body>
</html>
