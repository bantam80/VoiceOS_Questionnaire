<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Technical Form Widget</title>
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; overflow: hidden;}
        .loader { 
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 2s linear infinite;
            margin: 50px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        iframe { width: 100%; height: 100vh; border: none; }
        .error { color: #cc0000; padding: 20px; text-align: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading" class="loader"></div>
    <div id="errorMsg" class="error hidden"></div>
    <iframe id="formFrame" class="hidden" src=""></iframe>

    <script>
        console.log("!!! SCRIPT STARTING !!!");

        // --- 1. SETUP EVENT LISTENERS (Define these BEFORE init) ---

        // Listener for the PageLoad event (Data from CRM)
        ZOHO.embeddedApp.on("PageLoad", function(data){
            console.log("!!! PAGE LOAD RECEIVED !!!", data);
            
            var recordId = data.EntityId;
            var module = data.Entity; // Should be "Deals"

            // Fetch Record Data
            ZOHO.CRM.API.getRecord({Entity: module, RecordID: recordId})
            .then(function(response){
                console.log("Record Fetched:", response);
                
                // HIDE THE SPINNER NOW
                document.getElementById("loading").classList.add("hidden");

                if(response.data && response.data.length > 0){
                    let deal = response.data[0];

                    // Helper Functions
                    const getVal = (val) => val ? encodeURIComponent(val) : "";
                    const getLookupId = (field) => (deal[field] && deal[field].id) ? deal[field].id : "";
                    const getLookupName = (field) => (deal[field] && deal[field].name) ? encodeURIComponent(deal[field].name) : "";

                    // Construct URL
                    let baseUrl = "https://zfrmz.com/dnGvP3BdtkGelCcfEGMb";
                    let params = [];

                    params.push("opp_id=" + getVal(deal.Form_Update_Key));
                    params.push("acct_name=" + getLookupName("Account_Name"));
                    params.push("end_cust_id=" + getLookupId("End_Customer"));
                    params.push("opp_name=" + getVal(deal.Deal_Name));
                    params.push("next_step=" + getVal(deal.Next_Step));
                    params.push("pipe=" + getVal(deal.Pipeline));
                    params.push("stage=" + getVal(deal.Stage));

                    let fullUrl = baseUrl + "?" + params.join("&");
                    console.log("Loading URL:", fullUrl);
                    
                    let frame = document.getElementById("formFrame");
                    frame.src = fullUrl;
                    frame.classList.remove("hidden");

                } else {
                    showError("Could not retrieve record data.");
                }
            })
            .catch(function(err){
                console.error("API Error:", err);
                showError("API Error: " + JSON.stringify(err));
            });
        });

        // Listener for the Thank You Page Signal (Auto-Advance)
        window.addEventListener("message", function(event){
            // Filter out Zoho's internal messages
            if(event.data === "FORM_SUBMITTED"){
                console.log("!!! FORM SUBMIT SIGNAL RECEIVED !!!");
                
                ZOHO.CRM.BLUEPRINT.proceed()
                .then(function(data){
                    console.log("Blueprint Advanced:", data);
                })
                .catch(function(err){
                    console.error("Blueprint Failed:", err);
                });
            }
        });

        // --- 2. INITIALIZE SDK (Last Step) ---
        ZOHO.embeddedApp.init().then(function(){
            console.log("!!! SDK INITIALIZED !!!");
            // Resize (Optional but good for popups)
            ZOHO.CRM.UI.Resize({height:"600", width:"800"});
        });

        function showError(msg) {
            document.getElementById("loading").classList.add("hidden");
            var errDiv = document.getElementById("errorMsg");
            errDiv.innerHTML = "<b>Error:</b> " + msg;
            errDiv.classList.remove("hidden");
        }
    </script>
</body>
</html>
